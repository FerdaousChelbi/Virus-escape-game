<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Virus Escape - ACM ENSTAB</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }
        body {
            font-family: 'Arial', sans-serif;
            background: #0a192f;
            color: #fff;
            text-align: center;
            overflow: hidden;
            height: 50vh;
            display: flex;
            flex-direction: column;
        }
        h2 {
            color: #ff6464;
            padding: 15px;
            font-size: 1.5rem;
            text-shadow: 0 0 10px rgba(255, 100, 100, 0.5);
        }
        #gameContainer {
            position: relative;
            margin: 0 auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            width: 100%;
        }
        #startScreen {
            background: rgba(10, 25, 47, 0.9);
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            margin: 0 auto;
            border: 1px solid #ff6464;
        }
        #startScreen h2 {
            color: #ff6464;
            margin-bottom: 15px;
        }
        #playerName {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #ff1e1e;
            border-radius: 5px;
            font-size: 16px;
            background: rgba(255, 30, 30, 0.1);
            color: white;
        }
        #startButton {
            background: linear-gradient(135deg, #ff1e1e, #ff6464);
            color: white;
            border: none;
            padding: 12px 0;
            width: 100%;
            font-size: 18px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        #startButton:active {
            transform: scale(0.98);
        }
        canvas {
            display: block;
            border: 3px solid #ff1e1e;
            background: #0a192f;
            border-radius: 10px;
            margin: 0 auto;
            max-width: 100%;
            max-height: 60vh;
            display: none;
        }
        .info-display {
            display: flex;
            justify-content: space-around;
            padding: 5px;
            font-size: 1.2rem;
            color: #ff6464;
            display: none;
        }
        .controls {
            display: grid;
            grid-template-areas:
                ". up ."
                "left down right";
            gap: 10px;
            padding: 10px;
            display: none;
            justify-content: center;
        }
        .controls button {
            background: rgba(255, 100, 100, 0.3);
            border: 2px solid #ff6464;
            color: white;
            font-size: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        .controls button:active {
            background: rgba(255, 100, 100, 0.7);
        }
        #up { grid-area: up; }
        #left { grid-area: left; }
        #down { grid-area: down; }
        #right { grid-area: right; }
        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(10, 25, 47, 0.95);
            color: #ff6464;
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #ff6464;
            text-align: center;
            display: none;
            width: 70%;
            max-width: 300px;
            z-index: 10;
        }
        #gameOver h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: #4CAF50;
        }
        #resultScore {
            font-size: 1rem;
            margin: 10px 0;
        }
        #dashboard {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(10, 25, 47, 0.9);
            padding: 5px;
            border-top: 2px solid #ff6464;
            display: none;
            z-index: 5;
        }
        #dashboard h3 {
            color: #ff6464;
            margin-bottom: 5px;
            font-size: 1rem;
        }
        #leaderboard {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }
        #backButton {
            background: #ff6464;
            color: white;
            border: none;
            padding: 10px 20px;
            margin-top: 15px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        #soundToggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 100, 100, 0.3);
            border: 2px solid #ff6464;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 20;
        }
    </style>
</head>
<body>
    <h2>Virus Escape - ACM ENSTAB</h2>
    <div id="soundToggle">üîä</div>
    <div id="gameContainer">
        <div id="startScreen">
            <h2>Entrez votre pseudo</h2>
            <input type="text" id="playerName" placeholder="Votre nom..." maxlength="12" autocomplete="off">
            <button id="startButton">D√âMARRER</button>
        </div>
        <div class="info-display">
            <div id="playerDisplay"></div>
            <div id="timer">30s</div>
            <div id="score">0 pts</div>
        </div>
        <canvas id="gameCanvas"></canvas>
        <div id="gameOver">
            <h2 id="resultTitle"></h2>
            <p id="resultScore"></p>
            <button id="backButton">RETOUR</button>
        </div>
    </div>
    <div class="controls">
        <button id="up">‚¨ÜÔ∏è</button>
        <button id="left">‚¨ÖÔ∏è</button>
        <button id="down">‚¨áÔ∏è</button>
        <button id="right">‚û°Ô∏è</button>
    </div>
    <div id="dashboard">
        <h3>Top 5 des Joueurs</h3>
        <div id="leaderboard"></div>
    </div>

    <!-- Audio elements -->
    <audio id="backgroundMusic" loop>
        <source src="Sonic.m4a" type="audio/mpeg">
    </audio>
    <audio id="collisionSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-explosion-2759.mp3" type="audio/mpeg">
    </audio>
    <audio id="scoreSound">
        <source src="Coin Collect.m4a" type="audio/mpeg">
    </audio>
    <audio id="winSound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mpeg">
    </audio>

    <script>
        // √âl√©ments du DOM
        const elements = {
            canvas: document.getElementById("gameCanvas"),
            startScreen: document.getElementById("startScreen"),
            playerName: document.getElementById("playerName"),
            startButton: document.getElementById("startButton"),
            infoDisplay: document.querySelector(".info-display"),
            playerDisplay: document.getElementById("playerDisplay"),
            timer: document.getElementById("timer"),
            score: document.getElementById("score"),
            gameOver: document.getElementById("gameOver"),
            resultTitle: document.getElementById("resultTitle"),
            resultScore: document.getElementById("resultScore"),
            backButton: document.getElementById("backButton"),
            controls: document.querySelector(".controls"),
            up: document.getElementById("up"),
            left: document.getElementById("left"),
            down: document.getElementById("down"),
            right: document.getElementById("right"),
            dashboard: document.getElementById("dashboard"),
            leaderboard: document.getElementById("leaderboard"),
            soundToggle: document.getElementById("soundToggle"),
            backgroundMusic: document.getElementById("backgroundMusic"),
            collisionSound: document.getElementById("collisionSound"),
            scoreSound: document.getElementById("scoreSound"),
            winSound: document.getElementById("winSound")
        };

        // Contexte du canvas
        const ctx = elements.canvas.getContext("2d");
        
        // Configuration du jeu
        const config = {
            playerSize: 50,
            playerSpeed: 2,
            virusSpawnRate: 1500,
            gameDuration: 30,
            minVirusSize: 20,
            maxVirusSize: 30,
            minVirusSpeed: 0.5,
            maxVirusSpeed: 1
        };

        // √âtat du jeu
        const state = {
            player: {
                x: 0,
                y: 0,
                name: ""
            },
            viruses: [],
            score: 0,
            timeLeft: config.gameDuration,
            gameActive: false,
            lastVirusTime: 0,
            animationId: null,
            canvasSize: {
                width: 0,
                height: 0
            },
            keys: {
                ArrowUp: false,
                ArrowDown: false,
                ArrowLeft: false,
                ArrowRight: false
            },
            leaderboard: [],
            soundEnabled: true
        };

        // Gestion du son
        elements.soundToggle.addEventListener("click", () => {
            state.soundEnabled = !state.soundEnabled;
            elements.soundToggle.textContent = state.soundEnabled ? "üîä" : "üîá";
            
            if (state.soundEnabled) {
                if (state.gameActive) {
                    elements.backgroundMusic.play().catch(e => console.log("Audio play prevented:", e));
                }
            } else {
                elements.backgroundMusic.pause();
                elements.collisionSound.pause();
                elements.scoreSound.pause();
                elements.winSound.pause();
            }
        });

        // Mettre √† jour le leaderboard
        function updateLeaderboard() {
            const sortedPlayers = [...state.leaderboard].sort((a, b) => b.score - a.score);
            const top5 = sortedPlayers.slice(0, 5);
            
            elements.leaderboard.innerHTML = '';
            top5.forEach((player, index) => {
                const entry = document.createElement('div');
                entry.className = 'leaderboard-entry';
                entry.innerHTML = `
                    <span>${index + 1}. ${player.name}</span>
                    <span>${player.score} pts</span>
                `;
                elements.leaderboard.appendChild(entry);
            });
        }

        // Images
        const images = {
            player: new Image(),
            virus: new Image()
        };

        // Initialisation des images
        images.player.src = "Logo.png";
        images.virus.src = "virus.png";

        // √âv√©nements tactiles
        const setupControls = () => {
            const handlePress = (direction) => {
                return (e) => {
                    e.preventDefault();
                    state.keys[direction] = true;
                };
            };

            const handleRelease = (e) => {
                e.preventDefault();
                for (const key in state.keys) {
                    state.keys[key] = false;
                }
            };

            // Pour mobile
            elements.up.addEventListener("touchstart", handlePress("ArrowUp"), { passive: false });
            elements.down.addEventListener("touchstart", handlePress("ArrowDown"), { passive: false });
            elements.left.addEventListener("touchstart", handlePress("ArrowLeft"), { passive: false });
            elements.right.addEventListener("touchstart", handlePress("ArrowRight"), { passive: false });

            // Pour PC (clics souris)
            elements.up.addEventListener("mousedown", handlePress("ArrowUp"));
            elements.down.addEventListener("mousedown", handlePress("ArrowDown"));
            elements.left.addEventListener("mousedown", handlePress("ArrowLeft"));
            elements.right.addEventListener("mousedown", handlePress("ArrowRight"));

            const controls = [elements.up, elements.down, elements.left, elements.right];
            controls.forEach(control => {
                control.addEventListener("touchend", handleRelease, { passive: false });
                control.addEventListener("touchcancel", handleRelease, { passive: false });
                control.addEventListener("mouseup", handleRelease);
                control.addEventListener("mouseleave", handleRelease);
            });
        };

        // Gestion des touches clavier
        const setupKeyboard = () => {
            document.addEventListener("keydown", (e) => {
                if (state.keys.hasOwnProperty(e.key)) {
                    state.keys[e.key] = true;
                }
            });

            document.addEventListener("keyup", (e) => {
                if (state.keys.hasOwnProperty(e.key)) {
                    state.keys[e.key] = false;
                }
            });
        };

        // Redimensionnement du canvas
        const resizeCanvas = () => {
            const maxWidth = window.innerWidth - 40;
            const maxHeight = window.innerHeight * 0.5;
            const ratio = 2/3;

            if (maxWidth / ratio <= maxHeight) {
                elements.canvas.width = maxWidth;
                elements.canvas.height = maxWidth / ratio;
            } else {
                elements.canvas.height = maxHeight;
                elements.canvas.width = maxHeight * ratio;
            }

            state.canvasSize.width = elements.canvas.width;
            state.canvasSize.height = elements.canvas.height;
            
            if (state.gameActive) {
                state.player.x = elements.canvas.width / 2 - config.playerSize / 2;
                state.player.y = elements.canvas.height - config.playerSize - 20;
            }
        };

        // Cr√©ation d'un nouveau virus
        const createVirus = () => {
            const size = Math.random() * (config.maxVirusSize - config.minVirusSize) + config.minVirusSize;
            state.viruses.push({
                x: Math.random() * (state.canvasSize.width - size),
                y: -size,
                width: size,
                height: size,
                speed: Math.random() * (config.maxVirusSpeed - config.minVirusSpeed) + config.minVirusSpeed
            });
        };

        // Mise √† jour du joueur
        const updatePlayer = () => {
            if (state.keys.ArrowUp && state.player.y > 0) {
                state.player.y -= config.playerSpeed;
            }
            if (state.keys.ArrowDown && state.player.y < state.canvasSize.height - config.playerSize) {
                state.player.y += config.playerSpeed;
            }
            if (state.keys.ArrowLeft && state.player.x > 0) {
                state.player.x -= config.playerSpeed;
            }
            if (state.keys.ArrowRight && state.player.x < state.canvasSize.width - config.playerSize) {
                state.player.x += config.playerSpeed;
            }
        };

        // Mise √† jour des virus
        const updateViruses = () => {
            const currentTime = Date.now();
            if (currentTime - state.lastVirusTime > config.virusSpawnRate && state.gameActive) {
                createVirus();
                state.lastVirusTime = currentTime;
            }

            for (let i = state.viruses.length - 1; i >= 0; i--) {
                state.viruses[i].y += state.viruses[i].speed;

                // D√©tection de collision
                if (
                    state.player.x < state.viruses[i].x + state.viruses[i].width &&
                    state.player.x + config.playerSize > state.viruses[i].x &&
                    state.player.y < state.viruses[i].y + state.viruses[i].height &&
                    state.player.y + config.playerSize > state.viruses[i].y
                ) {
                    if (state.soundEnabled) {
                        elements.collisionSound.currentTime = 0;
                        elements.collisionSound.play().catch(e => console.log("Audio play prevented:", e));
                    }
                    endGame(false);
                    return;
                }

                // Suppression des virus hors √©cran
                if (state.viruses[i].y > state.canvasSize.height) {
                    state.viruses.splice(i, 1);
                    state.score++;
                    elements.score.textContent = `${state.score} pts`;
                    if (state.soundEnabled) {
                        elements.scoreSound.currentTime = 0;
                        elements.scoreSound.play().catch(e => console.log("Audio play prevented:", e));
                    }
                }
            }
        };

        // Dessin des √©l√©ments
        const draw = () => {
            ctx.clearRect(0, 0, state.canvasSize.width, state.canvasSize.height);
            
            // Dessiner le joueur
            ctx.drawImage(
                images.player,
                state.player.x,
                state.player.y,
                config.playerSize,
                config.playerSize
            );
            
            // Dessiner les virus
            state.viruses.forEach(virus => {
                ctx.drawImage(
                    images.virus,
                    virus.x,
                    virus.y,
                    virus.width,
                    virus.height
                );
            });
        };

        // Boucle de jeu
        const gameLoop = () => {
            if (!state.gameActive) return;
            
            updatePlayer();
            updateViruses();
            draw();
            
            state.animationId = requestAnimationFrame(gameLoop);
        };

        // Timer du jeu
        const startTimer = () => {
            const timerInterval = setInterval(() => {
                if (!state.gameActive) {
                    clearInterval(timerInterval);
                    return;
                }
                
                state.timeLeft--;
                elements.timer.textContent = `${state.timeLeft}s`;
                
                if (state.timeLeft <= 0) {
                    if (state.soundEnabled) {
                        elements.winSound.play().catch(e => console.log("Audio play prevented:", e));
                    }
                    endGame(true);
                    clearInterval(timerInterval);
                }
            }, 1000);
        };

        // Fin du jeu
        const endGame = (timeOut) => {
            state.gameActive = false;
            cancelAnimationFrame(state.animationId);
            
            // Arr√™ter la musique de fond
            elements.backgroundMusic.pause();
            
            // Mettre √† jour le leaderboard
            state.leaderboard.push({
                name: state.player.name,
                score: state.score
            });
            updateLeaderboard();
            
            elements.gameOver.style.display = "block";
            
            // Messages de fin
            if (timeOut) {
                elements.resultTitle.textContent = "F√©licitations !";
                elements.resultScore.textContent = `Vous avez gagn√© ${state.score} points !`;
            } else {
                elements.resultTitle.textContent = "Partie termin√©e";
                elements.resultScore.textContent = `Score final: ${state.score} points`;
            }
        };

        // Retour √† l'accueil
        elements.backButton.addEventListener("click", () => {
            elements.gameOver.style.display = "none";
            elements.canvas.style.display = "none";
            elements.infoDisplay.style.display = "none";
            elements.controls.style.display = "none";
            elements.dashboard.style.display = "none";
            
            elements.startScreen.style.display = "block";
            
            // R√©initialisation
            state.viruses = [];
            state.score = 0;
            state.timeLeft = config.gameDuration;
        });

        // D√©marrer le jeu
        const startGame = () => {
            state.player.name = elements.playerName.value.trim() || "Joueur";
            
            elements.startScreen.style.display = "none";
            elements.canvas.style.display = "block";
            elements.infoDisplay.style.display = "flex";
            elements.controls.style.display = "grid";
            elements.dashboard.style.display = "block";
            
            elements.playerDisplay.textContent = state.player.name;
            
            resizeCanvas();
            
            // Initialisation du jeu
            state.gameActive = true;
            state.player.x = state.canvasSize.width / 2 - config.playerSize / 2;
            state.player.y = state.canvasSize.height - config.playerSize - 20;
            state.score = 0;
            state.timeLeft = config.gameDuration;
            
            elements.score.textContent = "0 pts";
            elements.timer.textContent = `${config.gameDuration}s`;
            
            // D√©marrer la musique de fond
            if (state.soundEnabled) {
                elements.backgroundMusic.volume = 0.3;
                elements.backgroundMusic.play().catch(e => console.log("Audio play prevented:", e));
            }
            
            startTimer();
            gameLoop();
        };

        // Initialisation
        const init = () => {
            // √âv√©nements
            elements.startButton.addEventListener("click", startGame);
            elements.playerName.addEventListener("keypress", (e) => {
                if (e.key === "Enter") startGame();
            });
            
            setupControls();
            setupKeyboard();
            window.addEventListener("resize", resizeCanvas);
            
            // Chargement des images
            let imagesLoaded = 0;
            const imageLoaded = () => {
                imagesLoaded++;
                if (imagesLoaded === 2) {
                    resizeCanvas();
                }
            };
            images.player.onload = imageLoaded;
            images.virus.onload = imageLoaded;
        };

        // D√©marrer l'application
        init();
    </script>
</body>
</html>

